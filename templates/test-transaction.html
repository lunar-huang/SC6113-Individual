<!DOCTYPE html>
<html>
<script src="https://cdn.jsdelivr.net/npm/web3@1.5.2/dist/web3.min.js"></script>
<script>
    let web3;
    let account;
    const contractAddress = "0x68373fCaDd421231E0b8a55B69d6423df15F8D3a";
    // 连接到 MetaMask 并获取用户的账户
    if (typeof window.ethereum !== 'undefined') {
        // 使用MetaMask的提供商
        web3 = new Web3(window.ethereum);

        // 请求访问账户
        window.ethereum.request({ method: 'eth_requestAccounts' })
            .then(accounts => {
                console.log("Connected account:", accounts[0]);
                // 此处可以继续调用后续函数，例如获取交易信息
            })
            .catch((error) => {
                console.error("Error connecting to MetaMask", error);
            });
    } else {
        console.error("MetaMask is not installed!");
    }

    async function connectMetaMask() {
        if (window.ethereum) {
            try {
                // 请求连接 MetaMask
                await window.ethereum.request({ method: 'eth_requestAccounts' });

                // 创建 Web3 实例，使用 MetaMask 提供的 provider
                web3 = new Web3(window.ethereum);

                // 获取用户的账户
                const accounts = await web3.eth.getAccounts();
                account = accounts[0];

                console.log("Connected account:", account);

                // 在这里可以继续调用合约方法
                getRecentTransactions(); // 调用获取交易的函数
            } catch (error) {
                console.error("User denied account access:", error);
            }
        } else {
            console.error("MetaMask is not installed. Please install MetaMask to use this app.");
        }
    }

    async function getRecentTransactions(contractAddress) {
        if (!web3) {
            console.error('web3 is not defined');
            return;
        }
        const latestBlock = await web3.eth.getBlockNumber();
        const transactions = [];

        for (let i = latestBlock; i >= latestBlock - 100; i--) {
            const block = await web3.eth.getBlock(i, true);
            if (!block) continue;  // 确保块不为空

            block.transactions.forEach(tx => {
                if (tx.to && contractAddress && tx.to.toLowerCase() === contractAddress.toLowerCase()) {
                    transactions.push(tx);
                }
            });

            if (transactions.length >= 5) break; // 获取5笔最近交易
        }
        console.log("Recent transactions:", transactions);
        return transactions;
    }



    // 获取最近的10笔deposit交易
    getRecentTransactions(contractAddress);


    // 页面加载时，自动连接 MetaMask
    window.onload = async () => {
        await connectMetaMask();
    };

</script>

<body>
    <h1>Connect to MetaMask</h1>
</body>

</html>